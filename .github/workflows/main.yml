name: Update Blocklists

on:
  # 1. Run automatically every hour
  schedule:
    - cron: '0 * * * *'
  
  # 2. Manual Trigger with Advanced Options
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force Update (Ignore local file diffs)'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry Run (Simulate only - no API calls)'
        required: false
        type: boolean
        default: false

jobs:
  update-blocklists:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Safety timeout to prevent hanging jobs
    
    # REQUIRED: Allows the script to commit/push changes back to the repo
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Download full history for git diff

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        # The new script only requires 'requests'
        run: pip install requests

      - name: Run Blocklist Manager
        env:
          API_TOKEN: ${{ secrets.API_TOKEN }}
          ACCOUNT_ID: ${{ secrets.ACCOUNT_ID }}
          # Optional: Add this secret to your repo for Discord/Slack alerts
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          # Construct flags based on manual inputs
          FLAGS=""
          
          if [ "${{ inputs.force_update }}" == "true" ]; then
            echo "‚ö†Ô∏è FORCE MODE ACTIVE"
            FLAGS="$FLAGS --force"
          fi
          
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "üß™ DRY RUN ACTIVE"
            FLAGS="$FLAGS --dry-run"
          fi

          # Run the script
          python3 block_ads_sync.py $FLAGS
