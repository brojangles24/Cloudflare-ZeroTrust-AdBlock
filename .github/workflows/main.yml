name: Cloudflare Gateway Sync

on:
  # 1. Automatic: Run every day at 04:00 UTC
  schedule:
    - cron: '0 * * * *'

  # 2. Manual: Trigger with options
  workflow_dispatch:
    inputs:
      force_mode:
        description: 'Force Update (Ignore local file diffs)'
        type: boolean
        default: false
      delete_mode:
        description: '‚ö†Ô∏è Cleanup Mode (Delete all lists/relevant policies)'
        type: boolean
        default: false

jobs:
  run-sync:
    runs-on: ubuntu-latest
    
    # REQUIRED: Grants permission to commit and push changes back to the repo
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history so git diff/reset works correctly

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install requests

      - name: Run Blocklist Manager
        env:
          # You must set these in your Repository Settings > Secrets and Variables > Actions
          API_TOKEN: ${{ secrets.API_TOKEN }}
          ACCOUNT_ID: ${{ secrets.ACCOUNT_ID }}
        run: |
          # Initialize arguments variable
          SCRIPT_ARGS=""

          # Check for Manual Inputs
          if [ "${{ inputs.force_mode }}" == "true" ]; then
            echo "üî• Force Mode Active"
            SCRIPT_ARGS="$SCRIPT_ARGS --force"
          fi

          if [ "${{ inputs.delete_mode }}" == "true" ]; then
            echo "‚ö†Ô∏è Delete Mode Active"
            SCRIPT_ARGS="$SCRIPT_ARGS --delete"
          fi

          # Execute the script
          # IMPORTANT: Ensure your python file is named 'block_ads_sync.py' 
          # or change the name below to match your file.
          python3 block_ads_sync.py $SCRIPT_ARGS
