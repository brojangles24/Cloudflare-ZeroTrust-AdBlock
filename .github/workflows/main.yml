name: Update Blocklists

on:
  # 1. Run automatically every hour (UTC)
  schedule:
    - cron: '0 * * * *'
  
  # 2. Manual Trigger with Option to Delete
  workflow_dispatch:
    inputs:
      delete_mode:
        description: '⚠️ Check this to DELETE all lists.'
        required: false
        type: boolean
        default: false

jobs:
  update-blocklists:
    runs-on: ubuntu-latest
    
    # REQUIRED: Allows the script to commit/push changes back to the repo
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Download full history so git diff works correctly

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Use your specific version

      - name: Install Dependencies (Fixed)
        # We need 'requests' for HTTP and 'toml' for configuration
        run: pip install requests toml

      - name: Run Blocklist Manager
        env:
          # Secrets are automatically masked by GitHub Actions
          API_TOKEN: ${{ secrets.API_TOKEN }}
          ACCOUNT_ID: ${{ secrets.ACCOUNT_ID }}
        run: |
          # Check if the manual 'delete_mode' input was provided
          if [ "${{ github.event.inputs.delete_mode }}" == "true" ]; then
            echo "⚠️ DELETE MODE ACTIVE: Wiping all lists..."
            python3 block_ads_sync.py --delete
          else
            echo "✅ NORMAL MODE: Starting sync based on config.toml profile..."
            python3 block_ads_sync.py
          fi
